<!DOCTYPE>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>

<title>Alici</title>
<meta charset="utf-8">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link th:href="@{/styles/customer.css}" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<style>
.basket-book-image{width: 30px;}
</style>
</head>
<body>
<!--HTML BEGIN-->
<div th:replace="menu :: menu"></div>

<div id="main-content">
<button type="button" data-toggle="modal" data-target="#basketModal" onclick="openBasket()"
 id='open-basket-btn' class='btn btn-primary'>Səbət 
<span class='badge badge-light' id="basket-book-count">0</span></button>
<input id='search-input' class='form-control' placeholder='Axtarış'/>
</div>

<div class="modal fade" id="basketModal">
<div class="modal-dialog  modal-lg">
<div class="modal-content">
<div class="modal-header">
<h1 class="modal-title">Səbət</h1>
<button type="button" class="close" data-dismiss="modal">x</button>
</div>
<div class="modal-body">

<table class="table table-hover table-bordered">
<thead>
<tr><th>ID</th><th>Sekil</th><th>AD</th><th>Qiymet</th><th>Miqdar</th><th>Umumi qiymet</th><th></th></tr>
</thead>
<tbody id="basket-books-table">

</tbody>
</table>

<span id="total-price"></span>
</div>
<div class="modal-footer">
<a  class="btn btn-success" th:href="@{/confirm-order}">Sifarisi tesdiqle</a>
<button type="button" class="btn btn-danger" data-dismiss="modal">Bağla</button>
</div>
</div></div></div>
<!--HTML END-->
<script >
//JAVASCRIPT BEGIN
//REFRESH END
var mainContent=document.getElementById('main-content');
var mainContentHTML="";
var xht = new XMLHttpRequest();
var booksArrayGlobal=[];
var basketBooks=[];
var basketBooksFromStorage= localStorage.getItem('basketBooks')
if(basketBooksFromStorage==null){
	localStorage.setItem('basket','[]')
}else{
	basketBooks=JSON.parse(basketBooksFromStorage)
}

var openBasketButton = document.getElementById("open-basket-btn")
var basketBookCount = document.getElementById("basket-book-count")
var basketBooksTable = document.getElementById("basket-books-table")

var totalPrice = document.getElementById("total-price")
mainContent.innerHTML=mainContentHTML;
xht.onreadystatechange = function(){
	if(this.readyState == 4 && this.status == 200){
		var responseJSON=this.responseText
		var booksArray = JSON.parse(responseJSON);
		console.log(booksArray);
		booksArrayGlobal = booksArray.slice();
		

		
		
		for(var i=0;i<booksArray.length;i++){
		var book=booksArray[i];
		mainContentHTML+="<div class='book-container'>";
		mainContentHTML+="<div class='book'>";
		mainContentHTML+="<span class='book-image' style='background-image:url(/files/"+book.image+");'></span>";
		mainContentHTML+="<span class='book-name' title='"+
		book.name+"'>"+book.name+"</span>";
		mainContentHTML+="<span class='book-price' title='"+
		book.price+"'>"+book.price+"</span>";
		mainContentHTML+="<span class='book-description' title='"+
		book.description+"'>"+book.description+"</span>";
		mainContentHTML+="<span class='book-author' title='"+
		book.author+"'>"+book.author+"</span>";
		mainContentHTML+="<span class='book-page-count' title='"+
		book.pageCount+"'>"+book.pageCount+"</span> ";
		mainContentHTML+="<div class='add-to-basket'><button "+
		"class='add-to-basket-btn btn btn-primary' onclick='addToBasket("+book.id+")'>Səbətə at</button></div>";
		mainContentHTML+="</div></div>";
		}
		mainContent.innerHTML=mainContentHTML;
		
		
	}
};
xht.open("GET","/rest/books");
xht.send();





//REFRESH END
//FUNCTION BEGIN
function addToBasket(bookId){
	var bookExitsInBasket =true;
	
	for(var i=0;i<basketBooks.lenght;i++){
		var basketBook = basketBooks[i]
		if(basket.book.id == bookId){
			basketBook.count++;
			bookExitsInBasket=true;
			break;
		}
	}
	if(bookExitsInBasket){
		
	}else{
		for(var i=0;i<booksArrayGlobal.lenght;i++){
			if(booksArrayGlobal[i].id==bookId){
				var basketBook ={count:1,book:booksArrayGlobal[i]}
				basketBooks.push(basketBook).break
			}
		}	
	}
	
	openBasketButton.style.display="none";
	basketBookCount.innerHTML = basketBooks.lenght;
	localStorage.setItem("bookBaskets",JSON.stringfy(basketBooks))
	setTimeout(function(){openBasketButton.style.display="block";},300)
}

function openBasket(){
	fillBasketTable();
}

function deleteBasketBook(bookId){
	for(var i=0;i<basketBooks.length;i++){
		if(basketBooks[i].book.id==bookId){
			basketBooks.splice(i,1);
			break;
		}
	}
	openBasketButton.style.display="none";
	basketBookCount.innerHTML = basketBooks.lenght;
	setTimeout(function(){openBasketButton.style.display="block";},300)
	localStorage.setItem('',JSON.stringfy(basketBooks))
	fillBasketTable();
}

function fillBasketTable(){
	var basketBooksTableHTML="";
	for(var i=0;i<basketBooks.length;i++){
		var basketBook = basketBooks[i];
		basketBooksTableHTML+="<tr><td>"+basketBook.book.id;
		basketBooksTableHTML+="</td><td>"+
		"<img class='basket=book-image' src='/files/"+basketBook.book.image+"'>";
		basketBooksTableHTML+="</td><td>"+basketBook.book.name;
	    basketBooksTableHTML+="</td><td>"+basketBook.book.price;
		basketBooksTableHTML+="</td><td><input "+
		"type='number' oninput='onCountChanger("+basketBook.book.id+",this.value)' value='"+basketBook.book.count;
		basketBooksTableHTML+="'/></td><td id='book"+basketBook.book.id+"'>"+(basketBook.book.price*basketBook.count);
		basketBooksTableHTML+="</td><td><button onclick='deleteBasketBook("+basketBook.book.id+")' "+
		"class='btn btn-danger'>X<button>";
		basketBooksTableHTML+="</td></tr>";
	
	}
	basketBooksTable.innerHTML=basketBooksTableHTML
	calculateTotalPrice();
}

function onCountChanger(bookId,count){
	for(var i=0;i<basketBooks.length;i++){
		var basketBook = basketBooks[i];
		if(basketBook.book.id==bookId){
			basketBook.count = count;
			document.getElementById('book'+basketBook.book.id).
			innerHTML=(count*basketBook.book.price);
			
			break;
			}
	}
}

function calculateTotalPrice(){
	var totalPriceNumber =0;
	for(var i=0;i<basketBooks.length;i++){
		var basketBook = basketBooks[i];
		totalPriceNumber+=basketBook.book.count*basketBook.book.price;
}
	totalPrice.innerHTML="Umumi qiymet: "+totalPriceNumber+"AZN"
}
//FUNCTION END
//JAVASCRIPT END
</script>
</body>
</html>

